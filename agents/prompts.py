# -*- coding: utf-8 -*-
"""
所有提示词集中管理 — Send API 并行研究架构 v4
设计原则：
- 问题拆分和规划 → 思维树(ToT)：奥卡姆剃刀 + 证据驱动的精准拆分
- 研究分支(并行) → 思维链(CoT)：搜索 + 反思 + 百科验证 + 证据提取
- 全局验证 → 思维图(GoT)：推理链完整性评估（取代刚性覆盖率）
- 全局总结 → 思维链(CoT)：线性推理
"""


# ==================== 1. 问题拆分和规划（思维树 ToT + 奥卡姆剃刀） ====================

DECOMPOSE_PLAN_PROMPT = """你是一位问题分析大师。遵循奥卡姆剃刀原则，使用双向推理对问题进行精准拆分。

原始问题：{question}

已有证据池：
{existing_evidence}

已完成的子问题（无需重复）：
{completed_questions}

已尝试过的搜索方向及结果摘要（避免重复类似查询）：
{failed_queries}

## 核心原则
1. **奥卡姆剃刀**：只生成必需的子问题（2-4个），不重复已覆盖的方面
2. **双向推理**：正向（线索->实体）+ 逆向（答案格式->需要什么信息）
3. **渐进聚焦**：先锁定关键锚点实体，再围绕该实体展开验证
4. **不按顺序**：优先攻克最有区分度的锚点，不必按问题叙述顺序
5. **并行独立**：所有子问题将被同时并行执行，每个子问题必须完全自包含，绝对不能引用或依赖其他子问题的结果（如禁止写"根据上一问题的结果""使用从子问题1获得的姓名"等）
6. **查询多样性**：如果之前的搜索方向已经失败，必须换用完全不同的关键词、角度或搜索策略，不要只是微调措辞

## 第一步：双向推理分析

**正向推理**（从线索到答案）：
- 提取问题中所有可识别的具体线索（锚点）
- 哪个锚点最独特、最容易搜索到？-> 优先攻克

**逆向推理**（从答案到线索）：
- 最终答案需要什么形式？（人名？地名？年份？机构名？）
- 要得出该答案，最少需要确认哪些中间实体？
- 有没有可以跳过中间步骤、直接定位答案的捷径？
- 问题中是否存在可被多种方式理解的术语？对每个关键术语，考虑其最宽泛和最狭窄的解读，列出所有合理含义，不要过早锁死一种

## 第二步：聚焦分组
将子问题按「期望发现」分组——多个子问题可能是为了发现同一个中间实体：
- 例如：3个不同角度的搜索，都是为了找到"科比最后一场比赛的对手"-> 归纳为1-2个最精准的查询
- 避免为同一目标生成多个冗余查询

## 第三步：生成子问题
每个子问题应该清晰描述需要查找的信息。搜索工具会自动选择最合适的搜索引擎和查询格式，你只需描述清楚要查什么。

## 禁止事项
1. 禁止占位符如 [项目名称]、[学者姓名]
2. 禁止指代词（"这部"、"该"、"此"、"上述"），必须用具体名称
3. 已搜索过且无结果的查询不要重复，也不要仅微调措辞后重复（如把"20世纪80年代"改为"1980年至1989年"本质上是同一查询）
4. 禁止在子问题中使用 Markdown 格式符号
5. 禁止生成依赖其他子问题结果的子问题（如"根据上一问题确定的X，查找Y"），每个子问题必须独立可执行
6. 如果某个搜索方向连续两轮失败，应考虑原始问题中的关键术语是否有其他理解方式，或搜索范围是否需要扩大/缩小

输出格式：

## 锚点分析
（正向：列出所有锚点及其独特性）
（逆向：答案需要什么形式，最少需要确认哪些中间实体）

## 子问题列表
1. 子问题：（清晰描述需要查找的信息）
   重要性：高/中/低
   期望发现：（希望找到什么具体信息）
2. ..."""


# ==================== 2a. 研究分支 — 搜索工具选择（Function Calling） ====================

RESEARCH_SEARCH_PROMPT = """根据以下研究问题，选择最合适的搜索工具并执行搜索。

研究问题：{sub_question}
搜索目的：{purpose}
原始问题背景：{original_question}

请根据研究问题的语言和内容，调用最合适的搜索工具：
- 中文问题或中国相关话题 -> 优先 bocha_search（输入完整中文自然语言句子）
- 英文/国际话题 -> 优先 serper_search（输入英文关键词组合）
- 查询特定实体的详细百科信息 -> 优先 baike_search（输入实体名称）

你可以同时调用多个工具来获取更全面的信息。请确保为每个工具提供合适格式的查询内容。"""


# ==================== 2b. 研究分支 — 搜索反思（思维链 CoT） ====================

RESEARCH_REFLECT_PROMPT = """你是一位信息筛选专家。使用思维链(CoT)对搜索结果进行逐步分析。

研究问题：{sub_question}
搜索目的：{purpose}
原始问题背景：{original_question}

已有证据池（仅供交叉参考）：
{evidence_summary}

本次搜索结果：
{search_results}

## 反思步骤：

### 步骤1：逐条扫描
对每条搜索结果判断与原始问题的关联度（高/中/低/无），标注原因。

### 步骤2：实体提取（最重要！）
从高/中关联度结果中提取：项目名、人名、机构名、日期、地点、技术特征。

### 步骤3：证据稳定性检验（关键！）
对每个提取的实体/事实，评估其是否经得起推敲：
- **硬证据**：搜索结果中有明确、具体、可引用的事实陈述（如"科比·布莱恩特(Kobe Bryant)于2016年4月13日打完NBA最后一场比赛，得到60分"）
- **软假设**：仅基于推测、关联或模糊匹配得出的结论（如"可能是XX，因为描述相似"）
- **重要**：不要仅因为某个实体"看起来相关"就当作确认。如果搜索结果中没有直接提到原始问题的核心描述，该实体只能标记为假设，不能标记为已确认

### 步骤4：与已有证据的交叉关联
检查新发现的实体是否与证据池中的实体存在关联。
特别注意：新证据是否与已有证据矛盾？如果矛盾，哪个更可信？

### 步骤5：演绎推理与假设形成
- **排除法**：已知N对应M，排除已确认的，推断剩余
- **特征推断**：根据属性线索缩小范围
- **形成假设**："假设：XXX可能是YYY，依据：ZZZ"

### 步骤6：百科验证（可选）
如果你发现关键实体需要通过百度百科验证，可以直接调用 baike_search 工具进行查询。仅对最关键的1-2个实体进行验证。

输出格式：

## 反思过程
（逐步分析）

## 硬证据（有明确来源支撑的事实）
（每条一行，标注来源）

## 软假设（仅基于推测的结论）
（每条一行，标注推测依据和不确定性）

## 新发现的实体
（完整列出发现的所有具体实体名称）

## 交叉关联发现
（与已有证据的关联，特别标注矛盾点）"""


# ==================== 3. 研究分支 — 证据提取（思维链 CoT） ====================

RESEARCH_EVIDENCE_PROMPT = """你是一位证据总结专家。将搜索反思的结果浓缩为一条陈述性证据语句。

研究问题：{sub_question}
反思结果：
{reflection}
{baike_supplement}

要求：
1. 将所有有用信息浓缩为一句陈述性语句
2. 语句中必须保留所有发现的具体实体名称（英文名、中文名都要保留）
   好的示例："Apollo 11任务于1969年7月20日由NASA执行，Neil Armstrong和Buzz Aldrin成为首批登陆月球的人类"
   差的示例："某个航天任务与月球着陆有关"
3. **严格区分确认事实和推测假设**：
   - 有明确来源支撑的事实 → 直接陈述
   - 仅基于推测的结论 → 必须标注"（推测，依据：XXX）"
   - 不要把推测写成确认事实！这会误导后续推理
4. 如果搜索未获得有用信息，陈述为"关于[具体问题]的搜索未获得有效信息"
5. 评估可靠性：
   - high：多个独立来源直接印证同一事实
   - medium：单一可信来源明确陈述
   - low：信息模糊、仅靠推测、或来源不可靠

输出格式：
证据陈述：（一句话，包含所有具体实体名称，推测部分必须标注）
可靠性：（high / medium / low）"""


# ==================== 4. 全局验证（思维图 GoT — 推理链评估） ====================

GLOBAL_VERIFY_PROMPT = """你是一位推理验证专家。使用思维图(GoT)方法，评估推理链的完整性。

原始问题：{question}

所有子问题及状态：
{sub_questions_summary}

证据池：
{all_evidence}

## 任务：评估推理链是否足以回答原始问题

### 1. 证据关联图
将每条证据视为节点，分析支持/矛盾关系。
特别注意：不同证据中相同的实体名是关键连接点。

### 2. 推理链构建（核心！）
尝试构建从证据到最终答案的完整推理链：
- 步骤A：[证据X] → 得出中间结论1
- 步骤B：[证据Y] + 中间结论1 → 得出中间结论2
- ...
- 最终：→ 答案

### 2.5 假设审计（矛盾必查！）
当推理链中出现矛盾（如两条独立证据链指向不同答案），在搜索更多事实之前，**先审查你自己的推理中的隐含假设**：
1. **列出隐含假设**：你在理解问题或解读证据时，哪些理解是"想当然"的？
   - 审查每个关键术语：你是否不自觉地采用了最狭窄/最宽泛的含义？换一种理解方式会怎样？
   - 审查地理/组织/时间范围：你是否排除了某些本应包含在内的范围？（如总部所在地是否属于"该地区"？创立年是否算"建立首个分部"？）
   - 审查实体身份：你是否假设某实体只有一个名称、一种分类方式？
2. **逐一翻转假设**：对每个隐含假设，假设其反面成立，检查矛盾是否消失
3. **选择最简洁解释**（奥卡姆剃刀）：如果在某种解读下所有证据链完美吻合、无需额外假设，而另一种解读需要"也许有另一次火山喷发"之类的额外猜测，则前者几乎肯定正确
4. **警惕搜索死循环**：如果连续两轮搜索都无法解决同一个矛盾，问题极大概率出在你的解读上，而不是证据不足

### 3. 推理链完整性判断
评估标准（非刚性百分比，而是逻辑判断）：
- **充分**：推理链能从证据逻辑推导出一个明确答案（即使不是100%确定）
- **不充分**：推理链存在关键断裂，无法推导出任何合理答案
注意：不要因为"不够完美"就判断不充分。如果证据已经指向一个合理答案，即使缺少某些细节确认，也应判断为充分。
**重要**：如果矛盾在假设审计后通过重新解读消除了，应判断为充分，不要继续搜索。

### 4. 缺口分析与剪枝建议（仅当不充分时）
- **有价值的方向**：哪些已发现实体值得深入追查？
- **应剪枝的方向**：哪些搜索方向已证明无效，不应再浪费资源？

输出格式：

## 证据关系图
（描述证据间关联和矛盾）

## 推理链
（从证据到答案的完整推理过程）

## 假设审计
（列出推理中的隐含假设，逐一检查是否有替代解读能消除矛盾。如无矛盾则写"无矛盾，跳过"）

## 判断
充分性：（充分/不充分）
当前最佳答案：（即使不充分也给出最佳猜测）
缺口说明：（仅当不充分时，说明缺什么）
剪枝建议：（哪些方向应该放弃）"""


# ==================== 5. 全局总结（思维链 CoT） ====================

GLOBAL_SUMMARY_PROMPT = """你是一位最终推理专家。根据所有验证过的证据，使用思维链(CoT)推导最终答案。

原始问题：{question}

验证过的证据池：
{all_evidence}

推理链：
{reasoning_chain}

## 推理步骤：
1. 列出所有包含具体实体名称的有效证据（忽略"未获得有效信息"的）
2. 从最可靠的证据开始，逐步推导
3. 每一步引用具体证据编号
4. 如果有多个候选答案，选择与最多证据一致的那个
5. **多条件交叉验证（关键！）**：对于多跳关联问题（如"A同时满足条件X、Y、Z"），候选答案必须被验证为同时满足问题中的所有条件。如果一个实体仅出现在单一证据/单一条件中，而没有任何证据将其与其他条件关联，则该实体不应作为最终答案
6. 即使不是100%确定，也要给出最佳推断。但如果所有证据均明确表示"未获得有效信息"且没有任何候选实体被交叉验证，则从证据池中选择关联度最高的实体作为弱猜测

## 最终答案
（简洁精确的答案，直接回答原始问题。优先输出经过交叉验证的答案；若无法交叉验证，输出关联度最高的猜测）"""


# ==================== 答案格式化 ====================

FORMAT_ANSWER_PROMPT = """你是一个答案格式化专家。将答案按照题目要求精确格式化为最简形式。

原始问题：{question}
原始答案：{raw_answer}

格式化规则（严格执行）：
1. 只输出最终答案本身，不要有任何解释、推理过程或多余文字
2. 答案一般是名词或数字，必须是最简形式
3. 禁止添加括号注释，例如：
   - 错误："Kobe（科比）" → 正确："Kobe"
   - 错误："Tesla（特斯拉公司）" → 正确："Tesla"
   - 错误："魂武者（Soul Fighter）" → 正确："魂武者"
4. 禁止添加 Markdown 格式符号（如 **、*、#、` 等）
5. 如果题目用中文提问且答案是中文实体，直接输出中文；如果题目明确要求英文或答案本身是英文专有名词，输出英文
6. 英文答案：不要简单地全部转小写，专有名词保留原始大小写（如 "Kobe Bryant" 而非 "kobe bryant"）
7. 数值题均为整数，不带单位（除非题目要求带单位）
8. 多实体答案：用英文逗号加空格分隔（如 "A, B, C"），具体分隔符以题目要求为准
9. 去除首尾空格
10. 如果原始答案中包含多个候选，只输出最终确定的那一个
11. 如果题目或原始答案明确就是缩写（无括号，无全称），且缩写本身是标准答案，则保持缩写，不要强行展开

示例：
- 原始答案："答案是魂武者（Soul Fighter），这是一款格斗手游" → 输出："魂武者"
- 原始答案："大约是42岁" → 输出："42"
- 原始答案:"答案是IBM（International Business Machines Corporation），总部在纽约" → 输出:"International Business Machines Corporation"
- 原始答案:"原文只写 IBM，无括号、无全称" → 输出:"IBM"

直接输出格式化后的答案："""
