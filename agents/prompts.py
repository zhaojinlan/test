# -*- coding: utf-8 -*-
"""
所有提示词集中管理 — Send API 并行研究架构 v4
设计原则：
- 问题拆分和规划 → 思维树(ToT)：奥卡姆剃刀 + 证据驱动的精准拆分
- 研究分支(并行) → 思维链(CoT)：搜索 + 反思 + 百科验证 + 证据提取
- 全局验证 → 思维图(GoT)：推理链完整性评估（取代刚性覆盖率）
- 全局总结 → 思维链(CoT)：线性推理
"""


# ==================== 1. 问题拆分和规划（思维树 ToT + 奥卡姆剃刀） ====================

DECOMPOSE_PLAN_PROMPT = """你是一位问题分析大师。你的核心策略是：先用自身知识推理形成候选假设，再设计针对性的验证搜索。搜索的目的是验证和补充，而非从零发现。

原始问题：{question}

已有证据池：
{existing_evidence}

已完成的子问题（无需重复）：
{completed_questions}

已尝试过的搜索方向及结果摘要（避免重复类似查询）：
{failed_queries}

## 第一步：知识推理（最关键！在设计任何搜索之前必须完成）

你是一个拥有广泛知识的语言模型。在求助搜索引擎之前，先用你自身的知识对问题进行推理：

### 1.1 特征提取与候选推断
- 从问题中提取所有关键特征组合（时间、身份、事件、属性等）
- 对每个特征组合，调用你的知识：你能想到哪些具体的候选实体？
- 即使不100%确定也要列出，标注置信度（高/中/低）和推理依据
- 如果某个特征组合高度独特（如"16世纪+笔名诗人+法典编纂+军事领袖"），你很可能已经知道答案是谁——直接说出来

### 1.2 推理链构建
- 基于候选实体，尝试构建从已知到答案的推理链
- 如果推理链中有你不确定的环节，标记为"待验证"

### 1.3 知识缺口识别
- 你确定的事实有哪些？这些不需要搜索
- 你不确定或无法确认的关键事实有哪些？只有这些才需要搜索验证

## 第二步：设计验证性搜索（2-4个子问题）

基于第一步的推理结果，设计子问题。每个子问题必须服务于一个明确的验证目标：

### 验证类（优先）
- 针对你提出的候选实体，验证其是否满足问题中的特定条件
- 子问题中必须包含**具体实体名称**和**待验证的属性**
- 例如："验证苏莱曼一世是否以笔名Muhibbi创作诗歌"而非"查找16世纪以笔名创作诗歌的帝国统治者"

### 探索类（至少1个）
- 防止你的候选假设错误，探索替代候选
- 或者直接从另一个角度切入验证答案

### 补缺类
- 填补推理链中标记为"待验证"的关键环节

## 核心原则
1. **假设驱动**：搜索是为了验证假设，不是盲目发现。如果你已有候选，子问题中必须包含候选实体名
2. **禁止复述**：绝对禁止把原始问题的条件拆分后加"查找"变成子问题——那是复述不是分解
3. **奥卡姆剃刀**：只生成2-4个必需的子问题
4. **并行独立**：所有子问题同时执行，不能相互依赖，不能引用其他子问题的结果
5. **查询多样性**：如果之前的方向失败，换用完全不同的角度
6. **多候选探索**：至少保留1个子问题探索替代候选，防止确认偏差
7. **不重复**：已搜索过的方向不要重复，也不要仅微调措辞

## 禁止事项
1. 禁止把原始问题的条件拆分后简单加"查找"变成子问题
2. 禁止占位符如 [项目名称]、[学者姓名]
3. 禁止指代词（"这部"、"该"、"此"、"上述"），必须用具体名称
4. 禁止在子问题中使用 Markdown 格式符号
5. 禁止生成依赖其他子问题结果的子问题
6. 禁止在子问题中使用长描述性语句来代替你已知的实体名称

输出格式：

## 知识推理
候选假设：（列出候选实体、置信度、推理依据）
推理链：（从候选实体到最终答案的逻辑推导）
待验证：（需要搜索确认的关键事实）

## 子问题列表
1. 子问题：（具体实体名 + 待验证属性）
   验证目标：（验证哪个假设 / 探索哪个替代 / 填补哪个缺口）
   重要性：高/中/低
2. ..."""


# ==================== 2a. 研究分支 — 搜索工具选择（Function Calling） ====================

RESEARCH_SEARCH_PROMPT = """你是一位搜索查询构造专家。你的核心职责是将研究问题翻译为搜索引擎能高效匹配的查询。

研究问题：{sub_question}
搜索目的：{purpose}
原始问题背景：{original_question}

## 核心原则
搜索引擎是基于倒排索引的关键词匹配系统，不具备语义推理能力。你的角色是**查询翻译器**——在语义理解（LLM的能力）和关键词匹配（搜索引擎的能力）之间架起桥梁。

## 查询构造推理（在选择工具前，先完成以下思考）

### 步骤1：意图分解
- 这个研究问题本质上在寻找什么类型的信息？（人物身份？事件经过？概念定义？实体关系？）
- 什么样的网页最可能包含这个答案？（百科词条？历史文献？新闻报道？学术论文？）

### 步骤2：关键词提取
- 从研究问题中识别**核心实体**（专有名词、人名、地名、作品名、术语）
- 识别**区分性属性**（时间、身份、特征等能缩小搜索范围的限定词）
- **丢弃**所有对搜索引擎无意义的成分：虚词（"的""了""一个"）、动词短语（"查找""确认"）、描述性从句（"以…闻名的""通过…建立的"）

### 步骤3：查询组装
- 将提取的核心实体和区分性属性组合为**2-5个关键词**的短查询
- 若已有候选实体名称，直接使用"实体名 + 待验证属性"作为查询
- 若问题涉及多语言内容，分别构造中文和英文两个版本的查询
- 一次搜索可并行调用多个工具，每个工具使用针对性优化的查询

### 步骤4：工具匹配
根据查询内容和语言选择最合适的工具：
- bocha_search：中文关键词查询，适合中文互联网内容
- serper_search：英文关键词查询，适合国际内容和学术资源
- baike_search：精确实体名称查询，适合获取实体的结构化百科信息

完成以上推理后，直接调用搜索工具执行查询。"""


# ==================== 2b. 研究分支 — 搜索反思（思维链 CoT） ====================

RESEARCH_REFLECT_PROMPT = """你是一位信息筛选专家。使用思维链(CoT)对搜索结果进行逐步分析。

研究问题：{sub_question}
搜索目的：{purpose}
原始问题背景：{original_question}

已有证据池（仅供交叉参考）：
{evidence_summary}

本次搜索结果：
{search_results}

## 反思步骤：

### 步骤1：分来源扫描（每个搜索引擎的结果必须分别检查！）
搜索结果可能来自多个搜索引擎（博查、Google、百科等）。即使某个引擎返回的结果大多无关，其他引擎的结果中仍可能包含关键信息。必须逐一检查每个来源的每条结果，不要因为前面的结果无关就跳过后面的。
对每条结果判断与研究问题的关联度（高/中/低/无），标注原因。

### 步骤2：实体提取（最重要！）
从高/中关联度结果中提取：项目名、人名、机构名、日期、地点、技术特征。
**即使只有1条结果包含关键信息，也必须提取**——不要因为其他结果无关就忽略这1条。

### 步骤3：证据稳定性检验（关键！）
对每个提取的实体/事实，评估其是否经得起推敲：
- **硬证据**：搜索结果中有明确、具体、可引用的事实陈述（如"科比·布莱恩特(Kobe Bryant)于2016年4月13日打完NBA最后一场比赛，得到60分"）
- **软假设**：仅基于推测、关联或模糊匹配得出的结论（如"可能是XX，因为描述相似"）
- **重要**：不要仅因为某个实体"看起来相关"就当作确认。如果搜索结果中没有直接提到原始问题的核心描述，该实体只能标记为假设，不能标记为已确认

### 步骤4：与已有证据的交叉关联
检查新发现的实体是否与证据池中的实体存在关联。
特别注意：新证据是否与已有证据矛盾？如果矛盾，哪个更可信？

### 步骤5：演绎推理与假设形成
- **排除法**：已知N对应M，排除已确认的，推断剩余
- **特征推断**：根据属性线索缩小范围
- **形成假设**："假设：XXX可能是YYY，依据：ZZZ"

### 步骤6：百科验证（可选）
如果你发现关键实体需要通过百度百科验证，可以直接调用 baike_search 工具进行查询。仅对最关键的1-2个实体进行验证。

输出格式：

## 反思过程
（逐步分析）

## 硬证据（有明确来源支撑的事实）
（每条一行，标注来源）

## 软假设（仅基于推测的结论）
（每条一行，标注推测依据和不确定性）

## 新发现的实体
（完整列出发现的所有具体实体名称）

## 交叉关联发现
（与已有证据的关联，特别标注矛盾点）"""


# ==================== 3. 研究分支 — 证据提取（思维链 CoT） ====================

RESEARCH_EVIDENCE_PROMPT = """你是一位证据总结专家。将搜索反思的结果浓缩为一条陈述性证据语句。

研究问题：{sub_question}
反思结果：
{reflection}
{baike_supplement}

要求：
1. 将所有有用信息浓缩为一句陈述性语句
2. 语句中必须保留所有发现的具体实体名称（英文名、中文名都要保留）
   好的示例："Apollo 11任务于1969年7月20日由NASA执行，Neil Armstrong和Buzz Aldrin成为首批登陆月球的人类"
   差的示例："某个航天任务与月球着陆有关"
3. **严格区分确认事实和推测假设**：
   - 有明确来源支撑的事实 → 直接陈述
   - 仅基于推测的结论 → 必须标注"（推测，依据：XXX）"
   - 不要把推测写成确认事实！这会误导后续推理
4. **"未获得有效信息"是最后手段**：只有当反思结果中确实没有任何与研究问题相关的实体名称、事实或线索时，才陈述为"关于[具体问题]的搜索未获得有效信息"。如果反思结果中提到了任何相关实体或事实（哪怕只有一条、哪怕来自单一来源），都必须提取并陈述，不要因为信息不够"完美"就丢弃
5. 评估可靠性：
   - high：多个独立来源直接印证同一事实
   - medium：单一可信来源明确陈述
   - low：信息模糊、仅靠推测、或来源不可靠

输出格式：
证据陈述：（一句话，包含所有具体实体名称，推测部分必须标注）
可靠性：（high / medium / low）"""


# ==================== 4. 全局验证（思维图 GoT — 推理链评估） ====================

GLOBAL_VERIFY_PROMPT = """你是一位推理验证专家。使用思维图(GoT)方法，评估推理链的完整性。

原始问题：{question}

所有子问题及状态：
{sub_questions_summary}

证据池：
{all_evidence}

## 任务：评估推理链是否足以回答原始问题

### 1. 证据关联图
将每条证据视为节点，分析支持/矛盾关系。
特别注意：不同证据中相同的实体名是关键连接点。

### 2. 推理链构建（核心！）
尝试构建从证据到最终答案的完整推理链：
- 步骤A：[证据X] → 得出中间结论1
- 步骤B：[证据Y] + 中间结论1 → 得出中间结论2
- ...
- 最终：→ 答案

**铁律：推理链中的每一步都必须引用证据池中的具体证据编号（如E10、E20）作为支撑。**
**绝对禁止**引入证据池之外的任何信息，包括但不限于：
- 不得使用"已知事实""外部知识""经查""根据常识"等方式补充证据池中没有的信息
- 不得凭你自身的训练数据知识来填补证据链的缺口（如"脑补"某期刊的目录、某实体的属性）
- 如果证据池中的信息不足以完成某个推理步骤，该步骤必须标记为"证据缺口"，而非用你的知识强行补全
- 违反此规则会导致幻觉污染整个推理链，使最终答案不可靠

**正确做法**：如果证据池无法支撑完整推理链，诚实地判断为"不充分"，并在缺口分析中指出需要搜索什么信息来填补缺口。让下一轮 DecomposePlan 去设计针对性搜索，而不是在这里用猜测代替证据。

### 2.1 条件核查清单（必做！）
从原始问题中提取所有明确陈述的条件，对当前候选答案逐一核查：
- 对每个条件标记：✓匹配（有证据支持）/ ✗不匹配（证据矛盾或明确不符）/ ?未验证（证据不足）
- 特别注意：性别、单复数、人称代词、因果关系、时间范围等硬性约束是不可协商的
- 如果任何条件标记为✗，该候选答案必须被排除，应寻找其他候选

### 2.5 假设审计（矛盾时才用！）
当推理链中出现矛盾（如两条独立证据链指向不同答案），在搜索更多事实之前，**先审查你自己的推理中的隐含假设**：
1. **严格区分可翻转假设与不可翻转事实（最关键！）**：
   - **可翻转（解读性假设）**：对术语的理解方式，如“西海岸的首个分部”可能指总部本身或卫星办公室；“某省”可能指更大的行政区域
   - **不可翻转（问题的明确陈述）**：问题中用明确语言表述的事实约束，包括性别（male/female）、数量（单数a singer/复数singers）、人称代词（her/his/their）、明确的因果关系（“became widely known after collaborating”）、实体类型（vocalist=个人歌手，不等于团体）等
   - **绝对禁止**：将问题的明确陈述当作“假设”来翻转（如不能把“female vocalist”翻转为“可以是女子团体”，不能把“a male singer became widely known after”翻转为“也许合作不是成名原因”）
2. **列出可翻转的解读性假设**：
   - 审查每个关键术语：你是否不自觉地采用了最狭窄/最宽泛的含义？换一种理解方式会怎样？
   - 审查地理/组织/时间范围：你是否排除了某些本应包含在内的范围？
   - 审查实体身份：你是否假设某实体只有一个名称、一种分类方式？
3. **逐一翻转可翻转假设**：对每个解读性假设，假设其反面成立，检查矛盾是否消失
4. **选择最简洁解释**（奥卡姆剃刀）：如果在某种解读下所有证据链完美吻合、无需额外假设，而另一种解读需要“也许有另一次火山喷发”之类的额外猜测，则前者几乎肯定正确
5. **警惕搜索死循环**：如果连续两轮搜索都无法解决同一个矛盾，问题极大概率出在你的解读上，而不是证据不足

### 3. 推理链完整性判断
评估标准（非刚性百分比，而是逻辑判断）：
- **充分**：推理链能从证据逻辑推导出一个明确答案，且该答案与原始问题的所有明确条件不冲突（参见步骤2.1的条件核查清单）
- **不充分**：推理链存在关键断裂，或候选答案与原始问题的某个明确条件直接矛盾（如问题说“male singer”但候选是女子团体）
注意：不要因为“不够完美”就判断不充分。如果证据已经指向一个合理答案，即使缺少某些细节确认，也应判断为充分。
**重要**：如果矛盾在假设审计后通过重新解读消除了，应判断为充分，不要继续搜索。
**但是**：假设审计不能消除候选答案与问题明确条件之间的矛盾。如果条件核查清单中有任何✗，必须判断为不充分并寻找其他候选。

### 4. 缺口分析与剪枝建议（仅当不充分时）
- **有价值的方向**：哪些已发现实体值得深入追查？
- **应剪枝的方向**：哪些搜索方向已证明无效，不应再浪费资源？

输出格式：

## 证据关系图
（描述证据间关联和矛盾）

## 推理链
（从证据到答案的完整推理过程）

## 条件核查清单
（列出原始问题的每个明确条件，对候选答案逐一标记 ✓/✗/?)

## 假设审计
（仅列出可翻转的解读性假设，绝对不包括问题的明确陈述。如无矛盾则写“无矛盾，跳过”）

## 判断
充分性：（充分/不充分）
当前最佳答案：（即使不充分也给出最佳猜测）
缺口说明：（仅当不充分时，说明缺什么）
剪枝建议：（哪些方向应该放弃）
"""

# ==================== 5. 全局总结（思维链 CoT） ====================

GLOBAL_SUMMARY_PROMPT = """你是一位最终推理专家。根据所有验证过的证据，使用思维链(CoT)推导最终答案。

原始问题：{question}

验证过的证据池：
{all_evidence}

推理链：
{reasoning_chain}

## 推理步骤：
1. 列出所有包含具体实体名称的有效证据（忽略"未获得有效信息"的）
2. 从最可靠的证据开始，逐步推导
3. 每一步引用具体证据编号
4. 如果有多个候选答案，选择与最多证据一致的那个
5. **多条件交叉验证（关键！）**：对于多跳关联问题（如"A同时满足条件X、Y、Z"），候选答案必须被验证为同时满足问题中的所有条件。如果一个实体仅出现在单一证据/单一条件中，而没有任何证据将其与其他条件关联，则该实体不应作为最终答案
6. 即使不是100%确定，也要给出最佳推断。但如果所有证据均明确表示"未获得有效信息"且没有任何候选实体被交叉验证，则从证据池中选择关联度最高的实体作为弱猜测

**铁律：你只能使用上方"验证过的证据池"中的信息进行推理。绝对禁止引入证据池之外的任何知识、事实或假设来补充推理链。如果证据不足，给出基于现有证据的最佳猜测，但不要编造新信息。**

## 最终答案
（简洁精确的答案，直接回答原始问题。优先输出经过交叉验证的答案；若无法交叉验证，输出关联度最高的猜测）"""


# ==================== 答案格式化 ====================

FORMAT_ANSWER_PROMPT = """你是一位答案格式化专家。你的任务不是简单的文本清理，而是确保最终答案在语义上精确回答原始问题。

原始问题：{question}
原始答案：{raw_answer}

## 格式化推理（按顺序执行，仅输出最终结果）

### 步骤1：问题意图分析
分析原始问题的疑问焦点：
- 问题在问什么**类型**的事物？（从问题的疑问词和上下文推断：人名、地名、数字、事件名、概念名、作品名……）
- 问题期望什么**语言**？（中文提问通常期望中文答案，明确要求英文或答案本身是外文专有名词时用原文）
- 问题期望什么**粒度**？（全名 vs 简称、精确数字 vs 近似值、单个实体 vs 列表）

### 步骤2：核心答案提取
从原始答案中剥离非答案成分，答案必须是最简形式：
- 移除推理过程、解释性文字、前缀（"答案是""根据分析""综合来看"等）
- 移除括号中的注释或翻译（如"Kobe（科比）"→"Kobe"，"魂武者（Soul Fighter）"→"魂武者"）
- 移除 Markdown 格式符号（**、*、#、`等）
- 若有多个候选，仅保留最终确定的那一个

### 步骤3：语义对齐（最关键！）
将提取的核心答案与步骤1确定的问题意图进行对齐：
- **类型对齐**：答案的实体类别是否匹配问题所问的类别？如果问题问的是A类事物，而答案给的是语义相关但类别不同的B类事物，必须将答案转换为A类的正确表述（核心概念不变，类别词对齐）
- **语言对齐**：答案语言是否匹配问题的语言期望？
- **粒度对齐**：答案的详细程度是否匹配问题的要求？

### 步骤4：最终归一化
- 去除首尾空格
- 英文专有名词保留原始大小写（如 "Kobe Bryant" 而非 "kobe bryant"）
- 数值题输出纯整数，不带单位（除非题目明确要求带单位）
- 多实体用英文逗号加空格分隔（如 "A, B, C"），具体分隔符以题目要求为准
- 缩写处理：若原始答案本身就是标准缩写（无括号全称），保持缩写不展开；若有括号全称，取全称

仅输出最终格式化后的答案，不要输出任何分析过程："""


# ==================== 实体预校验（decompose后、research前） ====================

ENTITY_PRECHECK_PROMPT = """你是一位快速事实核查助手。验证候选实体是否与原始问题的描述基本匹配。

原始问题：{question}

分析中提出的候选假设：
{candidates_analysis}

以下是对候选实体的百科查询结果：
{baike_info}

## 任务
快速判断百科信息是否明显推翻了候选假设中的核心实体。

### 判断标准
- **通过**：百科信息支持候选假设的核心实体，或百科信息不足以判断（信息不足不等于推翻）
- **不通过**：百科信息明确与候选假设的关键属性矛盾（如时代不对、身份不符、领域错误、国籍错误等）

**重要**：
1. 只有在百科信息**明确推翻**核心假设时才判断"不通过"
2. 如果百科没有相关词条、信息不全，应判断"通过"（宁可放行，不可误杀）
3. 只校验排名最高的1-2个候选实体

仅输出两行：
判断：通过/不通过
反馈：（如不通过，简要说明哪个实体被推翻、原因、以及百科中发现的可能替代实体；如通过，写"无"）"""


# ==================== 合并版反思+证据提取（研究子图用） ====================

RESEARCH_REFLECT_EVIDENCE_PROMPT = """你是一位信息筛选和证据提取专家。对搜索结果进行分析，并直接提取出一条关键证据。

研究问题：{sub_question}
搜索目的：{purpose}
原始问题背景：{original_question}

已有证据池（仅供交叉参考）：
{evidence_summary}

本次搜索结果：
{search_results}

## 第一步：反思分析

### 1.1 分来源扫描
搜索结果可能来自多个搜索引擎。逐一检查每条结果与研究问题的关联度（高/中/低/无）。
**即使某个引擎结果大多无关，其他引擎中仍可能包含关键信息——必须逐一检查。**

### 1.2 实体提取
从高/中关联度结果中提取具体实体名称（人名、机构名、日期、地点等）。
**即使只有1条结果包含关键信息，也必须提取。**

### 1.3 证据稳定性检验
- **硬证据**：搜索结果中有明确、可引用的事实陈述
- **软假设**：仅基于推测或关联得出的结论 → 必须标注为推测

### 1.4 百科验证（可选）
如果发现关键实体需要验证，可调用 baike_search 工具查询。仅对最关键的1-2个实体使用。

## 第二步：证据总结（必须输出！）

将所有有用信息浓缩为一条陈述性证据语句：
1. 保留所有发现的具体实体名称（中英文都保留）
2. 严格区分确认事实和推测（推测标注"（推测，依据：XXX）"）
3. "未获得有效信息"是最后手段——如有任何相关实体或事实，必须提取
4. 评估可靠性：high（多来源印证）/ medium（单一可信来源）/ low（推测或不可靠来源）

输出格式：

## 反思过程
（简要分析，不超过300字）

## 新发现的实体
（列出所有发现的具体实体名称）

## 证据总结
证据陈述：（一句话，包含所有具体实体名称，推测部分必须标注）
可靠性：（high / medium / low）"""


# ==================== 快速充分性检查（动态剪枝用） ====================

QUICK_CHECK_PROMPT = """你是快速推理评估助手。判断现有证据是否已足以回答原始问题。
注意：这是一个快速检查，不需要详细分析。只需判断是否能从现有证据中推导出明确答案。

原始问题：{question}

当前证据池（{evidence_count}条）：
{evidence}

## 判断标准
- 充分：仅凭上方证据池中的信息就能构建完整推理链，推导出一个明确、具体的答案（不是"可能""也许"）
- 不充分：证据链有关键断裂，或所有证据都是"未获得有效信息"，无法得出明确答案
- **注意：只能基于上方证据池中的信息判断，不得引入你自身知识来补充推理**

仅输出两行：
判断：充分/不充分
答案：（如充分则给出简洁答案，不充分则写"待定"）"""
