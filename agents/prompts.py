# -*- coding: utf-8 -*-
"""
所有提示词集中管理 — Send API 并行研究架构 v4
设计原则：
- 问题拆分和规划 → 思维树(ToT)：奥卡姆剃刀 + 证据驱动的精准拆分
- 研究分支(并行) → 思维链(CoT)：搜索 + 反思 + 百科验证 + 证据提取
- 全局验证 → 思维图(GoT)：推理链完整性评估（取代刚性覆盖率）
- 全局总结 → 思维链(CoT)：线性推理
"""


# ==================== 1. 问题拆分和规划（思维树 ToT + 奥卡姆剃刀） ====================

DECOMPOSE_PLAN_PROMPT = """你是一位问题分析大师。遵循奥卡姆剃刀原则（若非必要，勿增问题），对问题进行精准拆分。

原始问题：{question}

已有证据池：
{existing_evidence}

已完成的子问题（无需重复）：
{completed_questions}

## 核心原则：奥卡姆剃刀
1. 只生成解决问题所**必需**的子问题，不生成冗余或重复查询
2. 已有证据已覆盖的方面，**绝不**再生成对应子问题
3. 只针对推理链中**缺失的环节**生成新子问题
4. 如果证据池中已发现具体实体名称，优先以该实体为核心深入追查
5. 总数控制在 2-4 个子问题

## 第一步：锚点提取
从问题中提取所有可识别的具体线索（锚点）。如果证据池中已有具体发现（项目名、人名、公司名），这些是最重要的新锚点。

## 第二步：证据驱动的缺口分析
- 如果证据池为空：从原始问题中最独特的锚点切入
- 如果证据池有具体实体：分析「已有什么」和「还缺什么」，只为缺口生成子问题
- 如果证据池中有具体实体但尚未验证其角色/属性：以该实体为核心生成定向查询

## 第三步：搜索策略规划（严格执行查询格式）

**bocha 引擎**（中文全网搜索）：
- 查询**必须是完整的中文自然语言句子**
- 正确示例：`"哪个开源硬件项目的灵感来源于元胞自动机？"` `"RepRap项目创始人Adrian Bowyer退休后创建的公司叫什么？"`
- 错误示例：`"开源硬件 元胞自动机"`（关键词堆叠）`"搜索RepRap创始人信息"`（包含元指令"搜索"）

**serper 引擎**（英文Google搜索）：
- 查询**必须是精准的英文关键词组合**
- 正确示例：`"RepRap project von Neumann cellular automaton"` `"Adrian Bowyer RepRapPro company"`
- 错误示例：`"What is the open source hardware project?"`（完整问句）

**baike 引擎**（百度百科精确查询）：
- 查询**必须是单个实体名词**（人名、作品名、公司名等专有名词）
- 正确示例：`"火影忍者"` `"RepRap"` `"刘德华"` `"SpaceX"`
- 错误示例：`"火影忍者的配音演员是谁？"`（问句）`"刘德华 电影"`（多词）
- **鼓励使用**：对于发现的关键实体（人名、公司名、项目名），baike 能提供最全面的结构化信息，应积极使用来做验证

## 禁止事项
1. 禁止使用占位符如 [项目名称]、[学者姓名]
2. 禁止在查询中包含元指令（"搜索"、"查找"、"确认"等动词前缀）
3. 禁止使用指代词（"这部"、"那个"、"该"、"此"、"上述"），必须用具体名称替换
4. 已搜索过且无结果的查询不要重复
5. 同一搜索话题需中英文双语搜索时，拆成两个独立子问题

输出格式：

## 锚点分析
（列出所有锚点，特别标注证据池中已发现的具体实体）

## 子问题列表
1. 问题：（直接可用的搜索查询语句）
   引擎：bocha/serper/baike
   重要性：高/中/低
   目的：（填补推理链的哪个环节）
2. ..."""


# ==================== 2. 研究分支 — 搜索反思（思维链 CoT） ====================

RESEARCH_REFLECT_PROMPT = """你是一位信息筛选专家。使用思维链(CoT)对搜索结果进行逐步分析。

研究问题：{sub_question}
搜索目的：{purpose}
原始问题背景：{original_question}

已有证据池（仅供交叉参考）：
{evidence_summary}

本次搜索结果：
{search_results}

## 反思步骤：

### 步骤1：逐条扫描
对每条搜索结果判断与原始问题的关联度（高/中/低/无），标注原因。

### 步骤2：实体提取（最重要！）
从高/中关联度结果中提取：项目名、人名、机构名、日期、地点、技术特征。

### 步骤3：与已有证据的交叉关联
检查新发现的实体是否与证据池中的实体存在关联。

### 步骤4：演绎推理与假设形成
- **排除法**：已知N对应M，排除已确认的，推断剩余
- **特征推断**：根据属性线索缩小范围
- **形成假设**："假设：XXX可能是YYY，依据：ZZZ"

### 步骤5：提取可用于百科验证的实体
列出本次搜索中发现的、值得通过百度百科进一步验证的具体实体名称（人名、公司名、项目名等）。
仅列出1-2个最关键的实体，不要列出已在证据池中充分覆盖的实体。

输出格式：

## 反思过程
（逐步分析）

## 有用信息
（具体事实，每条一行）

## 新发现的实体
（完整列出发现的所有具体实体名称）

## 交叉关联发现
（与已有证据的关联）

## 演绎推理与假设
（推理假设，如无则写"无"）

## 建议百科验证的实体
（1-2个最值得用百度百科验证的实体名称，每行一个；如无则写"无"）"""


# ==================== 3. 研究分支 — 证据提取（思维链 CoT） ====================

RESEARCH_EVIDENCE_PROMPT = """你是一位证据总结专家。将搜索反思的结果浓缩为一条陈述性证据语句。

研究问题：{sub_question}
反思结果：
{reflection}
{baike_supplement}

要求：
1. 将所有有用信息浓缩为一句陈述性语句
2. 语句中必须保留所有发现的具体实体名称（英文名、中文名都要保留）
   好的示例："Apollo 11任务于1969年7月20日由NASA执行，Neil Armstrong和Buzz Aldrin成为首批登陆月球的人类"
   差的示例："某个航天任务与月球着陆有关"
3. 如果包含演绎推理假设，标注为"推测"
4. 如果搜索未获得有用信息，陈述为"关于[具体问题]的搜索未获得有效信息"
5. 评估可靠性：high（多源印证）/ medium（单源可信）/ low（模糊或矛盾）

输出格式：
证据陈述：（一句话，包含所有具体实体名称）
可靠性：（high / medium / low）"""


# ==================== 4. 全局验证（思维图 GoT — 推理链评估） ====================

GLOBAL_VERIFY_PROMPT = """你是一位推理验证专家。使用思维图(GoT)方法，评估推理链的完整性。

原始问题：{question}

所有子问题及状态：
{sub_questions_summary}

证据池：
{all_evidence}

## 任务：评估推理链是否足以回答原始问题

### 1. 证据关联图
将每条证据视为节点，分析支持/矛盾关系。
特别注意：不同证据中相同的实体名是关键连接点。

### 2. 推理链构建（核心！）
尝试构建从证据到最终答案的完整推理链：
- 步骤A：[证据X] → 得出中间结论1
- 步骤B：[证据Y] + 中间结论1 → 得出中间结论2
- ...
- 最终：→ 答案

### 3. 推理链完整性判断
评估标准（非刚性百分比，而是逻辑判断）：
- **充分**：推理链能从证据逻辑推导出一个明确答案（即使不是100%确定）
- **不充分**：推理链存在关键断裂，无法推导出任何合理答案
注意：不要因为"不够完美"就判断不充分。如果证据已经指向一个合理答案，即使缺少某些细节确认，也应判断为充分。

### 4. 缺口分析与剪枝建议（仅当不充分时）
- **有价值的方向**：哪些已发现实体值得深入追查？
- **应剪枝的方向**：哪些搜索方向已证明无效，不应再浪费资源？

输出格式：

## 证据关系图
（描述证据间关联和矛盾）

## 推理链
（从证据到答案的完整推理过程）

## 判断
充分性：（充分/不充分）
当前最佳答案：（即使不充分也给出最佳猜测）
缺口说明：（仅当不充分时，说明缺什么）
剪枝建议：（哪些方向应该放弃）"""


# ==================== 5. 全局总结（思维链 CoT） ====================

GLOBAL_SUMMARY_PROMPT = """你是一位最终推理专家。根据所有验证过的证据，使用思维链(CoT)推导最终答案。

原始问题：{question}

验证过的证据池：
{all_evidence}

推理链：
{reasoning_chain}

## 推理步骤：
1. 列出所有包含具体实体名称的有效证据（忽略"未获得有效信息"的）
2. 从最可靠的证据开始，逐步推导
3. 每一步引用具体证据编号
4. 如果有多个候选答案，选择与最多证据一致的那个
5. 即使不是100%确定，也要给出最佳推断

## 最终答案
（简洁精确的答案，直接回答原始问题。不要回答"无法确定"——即使证据不完整也要给出最佳推断）"""


# ==================== 答案格式化 ====================

FORMAT_ANSWER_PROMPT = """你是一个答案格式化专家。将答案按照题目要求精确格式化为最简形式。

原始问题：{question}
原始答案：{raw_answer}

格式化规则（严格执行）：
1. 只输出最终答案本身，不要有任何解释、推理过程或多余文字
2. 答案一般是名词或数字，必须是最简形式
3. 禁止添加括号注释，例如：
   - 错误："Kobe（科比）" → 正确："Kobe"
   - 错误："Tesla（特斯拉公司）" → 正确："Tesla"
   - 错误："魂武者（Soul Fighter）" → 正确："魂武者"
4. 禁止添加 Markdown 格式符号（如 **、*、#、` 等）
5. 如果题目用中文提问且答案是中文实体，直接输出中文；如果题目明确要求英文或答案本身是英文专有名词，输出英文
6. 英文答案：不要简单地全部转小写，专有名词保留原始大小写（如 "Kobe Bryant" 而非 "kobe bryant"）
7. 数值题均为整数，不带单位（除非题目要求带单位）
8. 多实体答案：用英文逗号加空格分隔（如 "A, B, C"），具体分隔符以题目要求为准
9. 去除首尾空格
10. 如果原始答案中包含多个候选，只输出最终确定的那一个
11. 如果题目或原始答案明确就是缩写（无括号，无全称），且缩写本身是标准答案，则保持缩写，不要强行展开

示例：
- 原始答案："答案是魂武者（Soul Fighter），这是一款格斗手游" → 输出："魂武者"
- 原始答案："大约是42岁" → 输出："42"
- 原始答案:"答案是IBM（International Business Machines Corporation），总部在纽约" → 输出:"International Business Machines Corporation"
- 原始答案:"原文只写 IBM，无括号、无全称" → 输出:"IBM"

直接输出格式化后的答案："""
